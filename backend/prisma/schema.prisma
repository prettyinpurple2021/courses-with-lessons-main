generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                      String                   @id @default(uuid())
  email                   String                   @unique
  password                String
  firstName               String
  lastName                String
  avatar                  String?
  bio                     String?
  emailNotifications      Boolean                  @default(true)
  courseUpdates           Boolean                  @default(true)
  communityDigest         Boolean                  @default(true)
  achievementAlerts       Boolean                  @default(true)
  createdAt               DateTime                 @default(now())
  updatedAt               DateTime                 @updatedAt
  role                    String                   @default("student")
  totalStudyTime          Int                      @default(0) // in minutes
  currentStreak           Int                      @default(0) // in days
  longestStreak           Int                      @default(0) // in days
  lastStudyDate           DateTime?
  achievements            Achievement[]
  activitySubmissions     ActivitySubmission[]
  certificates            Certificate[]
  enrollments             Enrollment[]
  examResults             FinalExamResult[]
  projectSubmissions      FinalProjectSubmission[]
  forumPosts              ForumPost[]
  forumThreads            ForumThread[]
  lessonProgress          LessonProgress[]
  notes                   Note[]
  oauthAuthorizationCodes OAuthAuthorizationCode[]
  soloSuccessIntegration  SoloSuccessIntegration?
  cookieConsents          CookieConsent[]

  @@index([email])
  @@index([createdAt])
}

model Course {
  id           String        @id @default(uuid())
  courseNumber Int           @unique
  title        String
  description  String
  thumbnail    String
  published    Boolean       @default(false)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  certificates Certificate[]
  enrollments  Enrollment[]
  finalExam    FinalExam?
  finalProject FinalProject?
  lessons      Lesson[]

  @@index([courseNumber])
  @@index([published])
}

model Lesson {
  id             String           @id @default(uuid())
  courseId       String
  lessonNumber   Int
  title          String
  description    String
  youtubeVideoId String
  duration       Int
  activities     Activity[]
  course         Course           @relation(fields: [courseId], references: [id], onDelete: Cascade)
  progress       LessonProgress[]
  notes          Note[]
  resources      Resource[]

  @@unique([courseId, lessonNumber])
}

model Activity {
  id             String               @id @default(uuid())
  lessonId       String
  activityNumber Int
  title          String
  description    String
  type           String
  content        Json
  required       Boolean              @default(true)
  lesson         Lesson               @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  submissions    ActivitySubmission[]

  @@unique([lessonId, activityNumber])
}

model ActivitySubmission {
  id          String   @id @default(uuid())
  userId      String
  activityId  String
  response    Json
  completed   Boolean  @default(false)
  submittedAt DateTime @default(now())
  feedback    String?
  activity    Activity @relation(fields: [activityId], references: [id], onDelete: Cascade)
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, activityId])
  @@index([userId])
  @@index([activityId])
  @@index([userId, completed])
}

model FinalProject {
  id           String                   @id @default(uuid())
  courseId     String                   @unique
  title        String
  description  String
  instructions String
  requirements Json
  course       Course                   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  submissions  FinalProjectSubmission[]
}

model FinalProjectSubmission {
  id          String       @id @default(uuid())
  userId      String
  projectId   String
  submission  Json
  submittedAt DateTime     @default(now())
  status      String
  feedback    String?
  project     FinalProject @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, projectId])
}

model FinalExam {
  id           String            @id @default(uuid())
  courseId     String            @unique
  title        String
  description  String
  timeLimit    Int
  passingScore Int
  questions    ExamQuestion[]
  course       Course            @relation(fields: [courseId], references: [id], onDelete: Cascade)
  results      FinalExamResult[]
}

model ExamQuestion {
  id      String               @id @default(uuid())
  examId  String
  text    String
  type    String
  order   Int
  points  Int
  exam    FinalExam            @relation(fields: [examId], references: [id], onDelete: Cascade)
  options ExamQuestionOption[]
}

model ExamQuestionOption {
  id         String       @id @default(uuid())
  questionId String
  text       String
  isCorrect  Boolean
  order      Int
  question   ExamQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)
}

model FinalExamResult {
  id            String    @id @default(uuid())
  userId        String
  examId        String
  score         Int
  answers       Json
  passed        Boolean
  gradingStatus String    @default("GRADED") // GRADED, PENDING_REVIEW
  submittedAt   DateTime  @default(now())
  exam          FinalExam @relation(fields: [examId], references: [id], onDelete: Cascade)
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, examId])
}

model Enrollment {
  id              String    @id @default(uuid())
  userId          String
  courseId        String
  enrolledAt      DateTime  @default(now())
  completedAt     DateTime?
  currentLesson   Int       @default(1)
  unlockedCourses Int       @default(1)
  course          Course    @relation(fields: [courseId], references: [id], onDelete: Cascade)
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId])
  @@index([userId])
  @@index([courseId])
  @@index([userId, completedAt])
}

model LessonProgress {
  id              String    @id @default(uuid())
  userId          String
  lessonId        String
  completed       Boolean   @default(false)
  videoPosition   Int       @default(0)
  currentActivity Int       @default(1)
  completedAt     DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  lesson          Lesson    @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, lessonId])
  @@index([userId])
  @@index([lessonId])
  @@index([userId, completed])
}

model Achievement {
  id          String   @id @default(uuid())
  userId      String
  title       String
  description String
  icon        String
  rarity      String
  unlockedAt  DateTime @default(now())
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Certificate {
  id               String   @id @default(uuid())
  userId           String
  courseId         String
  issuedAt         DateTime @default(now())
  verificationCode String   @unique
  course           Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([courseId])
  @@index([verificationCode])
}

model Note {
  id        String   @id @default(uuid())
  userId    String
  lessonId  String
  content   String
  timestamp Int?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  lesson    Lesson   @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Resource {
  id          String  @id @default(uuid())
  lessonId    String
  title       String
  description String?
  fileUrl     String
  fileType    String
  fileSize    Int
  lesson      Lesson  @relation(fields: [lessonId], references: [id], onDelete: Cascade)
}

model ForumCategory {
  id          String        @id @default(uuid())
  name        String
  description String
  order       Int
  threads     ForumThread[]
}

model ForumThread {
  id         String        @id @default(uuid())
  categoryId String
  authorId   String
  title      String
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt
  isPinned   Boolean       @default(false)
  isLocked   Boolean       @default(false)
  posts      ForumPost[]
  author     User          @relation(fields: [authorId], references: [id], onDelete: Cascade)
  category   ForumCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@index([categoryId])
  @@index([authorId])
  @@index([createdAt])
  @@index([isPinned, updatedAt])
}

model ForumPost {
  id        String      @id @default(uuid())
  threadId  String
  authorId  String
  content   String
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  author    User        @relation(fields: [authorId], references: [id], onDelete: Cascade)
  thread    ForumThread @relation(fields: [threadId], references: [id], onDelete: Cascade)
}

model Event {
  id            String              @id @default(uuid())
  title         String
  description   String
  type          String
  startTime     DateTime
  endTime       DateTime
  location      String?
  maxAttendees  Int?
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
  registrations EventRegistration[]
}

model EventRegistration {
  id           String   @id @default(uuid())
  userId       String
  eventId      String
  registeredAt DateTime @default(now())
  attended     Boolean  @default(false)
  event        Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@unique([userId, eventId])
}

model OAuthClient {
  id                 String                   @id @default(uuid())
  clientId           String                   @unique
  clientSecret       String
  name               String
  redirectUri        String
  webhookUrl         String?
  webhookSecret      String?
  isActive           Boolean                  @default(true)
  createdAt          DateTime                 @default(now())
  updatedAt          DateTime                 @updatedAt
  authorizationCodes OAuthAuthorizationCode[]
  integrations       SoloSuccessIntegration[]

  @@index([clientId])
  @@index([isActive])
}

model OAuthAuthorizationCode {
  id          String      @id @default(uuid())
  code        String      @unique
  clientId    String
  userId      String
  redirectUri String
  expiresAt   DateTime
  used        Boolean     @default(false)
  createdAt   DateTime    @default(now())
  client      OAuthClient @relation(fields: [clientId], references: [id], onDelete: Cascade)
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([code])
  @@index([clientId])
  @@index([userId])
  @@index([expiresAt])
}

model SoloSuccessIntegration {
  id                String      @id @default(uuid())
  userId            String      @unique
  solosuccessUserId String
  oauthClientId     String
  accessToken       String?
  refreshToken      String?
  tokenExpiry       DateTime?
  subscriptionTier  String      @default("free")
  lastSyncAt        DateTime?
  syncStatus        String      @default("pending")
  isActive          Boolean     @default(true)
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  oauthClient       OAuthClient @relation(fields: [oauthClientId], references: [id], onDelete: Cascade)
  user              User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([solosuccessUserId])
  @@index([oauthClientId])
  @@index([isActive])
}

model CookieConsent {
  id          String   @id @default(cuid())
  userId      String?  // Nullable for anonymous users
  sessionId   String?  // For anonymous tracking (client-generated)
  preferences Json     // { necessary: boolean, analytics: boolean, marketing: boolean }
  version     String   @default("1.0")
  ipAddress   String?
  userAgent   String?
  timestamp   DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user User? @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([sessionId])
  @@index([timestamp])
  @@index([createdAt])
}
